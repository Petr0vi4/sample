{
	"info": {
		"_postman_id": "569d643a-6177-427c-8283-cb3c37a48f66",
		"name": "idempotency",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"item": [
		{
			"name": "1. регистрация пользователя",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "998e97a0-20c6-4bd0-becc-58997cb295c7",
						"exec": [
							"pm.test(\"Status code is 200\", function () {",
							"    pm.response.to.have.status(200);",
							"});",
							"",
							"pm.collectionVariables.set('userId', pm.response.json().id.toString());"
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "09b792ed-1b0b-45cd-8a29-c273a065bbb1",
						"exec": [
							"pm.collectionVariables.set(\"login\", pm.variables.replaceIn('{{$randomUserName}}'))",
							"pm.collectionVariables.set(\"password\", pm.variables.replaceIn('{{$randomPassword}}'))",
							"pm.collectionVariables.set(\"firstName\", pm.variables.replaceIn('{{$randomFirstName}}'))",
							"pm.collectionVariables.set(\"lastName\", pm.variables.replaceIn('{{$randomLastName}}'))",
							"pm.collectionVariables.set(\"email\", pm.variables.replaceIn('{{$randomEmail}}'))"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"username\": \"{{login}}\",\n    \"password\": \"{{password}}\",\n    \"first_name\": \"{{firstName}}\",\n    \"last_name\": \"{{lastName}}\",\n    \"email\": \"{{email}}\"\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "{{baseUrl}}/register",
					"host": [
						"{{baseUrl}}"
					],
					"path": [
						"register"
					]
				}
			},
			"response": []
		},
		{
			"name": "2. вход пользователя",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "f8c76ad5-5685-4b33-b1ee-72df09097607",
						"exec": [
							"pm.test(\"Status code is 200\", function () {",
							"    pm.response.to.have.status(200);",
							"});",
							"pm.test(\"Response contains a session_id cookie\", function() {",
							"    pm.expect(pm.cookies.has('session_id')).to.be.true;",
							"});",
							""
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"username\": \"{{login}}\",\n    \"password\": \"{{password}}\"\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "{{baseUrl}}/login",
					"host": [
						"{{baseUrl}}"
					],
					"path": [
						"login"
					]
				}
			},
			"response": []
		},
		{
			"name": "3. положить 100 на счет пользователя",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "df23d63c-8e0a-48f9-ba56-c3d25d53449a",
						"exec": [
							"pm.test(\"Status code is 200\", function () {",
							"    pm.response.to.have.status(200);",
							"});"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"amount\": 100.0\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "{{baseUrl}}/account/me/insert",
					"host": [
						"{{baseUrl}}"
					],
					"path": [
						"account",
						"me",
						"insert"
					]
				}
			},
			"response": []
		},
		{
			"name": "4. сделать заказ без заголовка X-Version",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "8be9a678-808d-4cec-a763-174bcba9be1d",
						"exec": [
							"pm.test(\"Status code is 400\", function () {",
							"    pm.response.to.have.status(400);",
							"});"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"amount\": 10.0\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "{{baseUrl}}/order",
					"host": [
						"{{baseUrl}}"
					],
					"path": [
						"order"
					]
				}
			},
			"response": []
		},
		{
			"name": "5. сделать заказ со случаным значением X-Version",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "b818bb1e-d640-4b41-88bf-26592d6bb3ad",
						"exec": [
							"pm.test(\"Status code is 409\", function () {",
							"    pm.response.to.have.status(409);",
							"});"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "X-Version",
						"type": "text",
						"value": "{{$randomUUID}}"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"amount\": 10.0\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "{{baseUrl}}/order",
					"host": [
						"{{baseUrl}}"
					],
					"path": [
						"order"
					]
				}
			},
			"response": []
		},
		{
			"name": "6. получить текущее значение X-Version",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "a1c5bf86-8f54-4193-bb08-506280f49f67",
						"exec": [
							"pm.test(\"Status code is 200\", function () {",
							"    pm.response.to.have.status(200);",
							"});",
							"pm.test(\"Response contains version property\", function () {",
							"    pm.expect(pm.response.json()).to.have.property('version');",
							"});",
							"",
							"pm.collectionVariables.set('version1', pm.response.json().version);"
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "0c708705-f2ea-4942-8ee0-db5eab0ce95c",
						"exec": [
							""
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "GET",
				"header": [],
				"url": {
					"raw": "{{baseUrl}}/order",
					"host": [
						"{{baseUrl}}"
					],
					"path": [
						"order"
					]
				}
			},
			"response": []
		},
		{
			"name": "7. сделать заказ с полученным значением X-Version",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "ed9c00ca-2148-4076-b316-3072f20af1c1",
						"exec": [
							"pm.test(\"Status code is 201\", function () {",
							"    pm.response.to.have.status(201);",
							"});",
							"",
							"pm.collectionVariables.set('orderId1', pm.response.json().id.toString());"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "X-Version",
						"type": "text",
						"value": "{{version1}}"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"amount\": 10.0\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "{{baseUrl}}/order",
					"host": [
						"{{baseUrl}}"
					],
					"path": [
						"order"
					]
				}
			},
			"response": []
		},
		{
			"name": "8. посмотреть деньги на счету пользователя и убедиться, что осталось 90",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "bf810345-d0d3-4235-80e1-f8be9b4349f4",
						"exec": [
							"pm.test(\"Status code is 200\", function () {",
							"    pm.response.to.have.status(200);",
							"});",
							"pm.test(\"User amount is 90\", function () {",
							"    pm.expect(pm.response.json().amount).to.be.equal(90);",
							"});"
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "7586d30f-721e-4243-be80-c2012718f126",
						"exec": [
							""
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "GET",
				"header": [],
				"url": {
					"raw": "{{baseUrl}}/account/me",
					"host": [
						"{{baseUrl}}"
					],
					"path": [
						"account",
						"me"
					]
				}
			},
			"response": []
		},
		{
			"name": "9. посмотреть в сервисе нотификаций отправленные сообщения и убедиться, что сообщение отправилось",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "ac9675f9-e324-4a21-ab8f-877643acc9d5",
						"exec": [
							"pm.test(\"Status code is 200\", function () {",
							"    pm.response.to.have.status(200);",
							"});",
							"",
							"const emails = pm.response.json() || [];",
							"const userEmail = emails.find(email => email.toAddress == \"{{email}}\" && email.messageBody.indexOf(\"№{{orderId1}}\") !== -1);",
							"",
							"pm.expect(userEmail).to.be.not.null;"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "GET",
				"header": [],
				"url": {
					"raw": "{{baseUrl}}/notification/email",
					"host": [
						"{{baseUrl}}"
					],
					"path": [
						"notification",
						"email"
					]
				}
			},
			"response": []
		},
		{
			"name": "10. получить новое значение X-Version",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "bb43afd1-4335-434f-bc0b-282aa8e82167",
						"exec": [
							"pm.test(\"Status code is 200\", function () {",
							"    pm.response.to.have.status(200);",
							"});",
							"pm.test(\"Response contains order with id \" + pm.collectionVariables.get('orderId1'), function () {",
							"    const orders = pm.response.json().list || [];",
							"    const order = orders.find(order => order.id == pm.collectionVariables.get('orderId1'));",
							"    pm.expect(order).to.be.not.undefined;",
							"});",
							"pm.test(\"Response contains version property\", function () {",
							"    pm.expect(pm.response.json()).to.have.property('version');",
							"});",
							"pm.test(\"Version property not equals \" + pm.collectionVariables.get('version1'), function () {",
							"    pm.expect(pm.response.json().version).to.be.not.equal(pm.collectionVariables.get('version1'));",
							"});",
							""
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "4b85730a-7a6d-4df9-ae09-6170b1f3ab49",
						"exec": [
							""
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "GET",
				"header": [],
				"url": {
					"raw": "{{baseUrl}}/order",
					"host": [
						"{{baseUrl}}"
					],
					"path": [
						"order"
					]
				}
			},
			"response": []
		}
	],
	"event": [
		{
			"listen": "prerequest",
			"script": {
				"id": "9e8e7178-e46b-42e5-97b8-5e04028cb076",
				"type": "text/javascript",
				"exec": [
					""
				]
			}
		},
		{
			"listen": "test",
			"script": {
				"id": "c6bbd504-72e2-48e0-8c58-9ecca36036de",
				"type": "text/javascript",
				"exec": [
					"pm.test(\"[INFO] Request: \" + (pm.request.body || \"\"));",
					"pm.test(\"[INFO] Response: \" + (pm.response.text()));"
				]
			}
		}
	],
	"variable": [
		{
			"id": "271a4649-3e3f-4fe2-871f-d216632e588b",
			"key": "baseUrl",
			"value": "http://arch.homework"
		},
		{
			"id": "49a60548-789d-40de-8f8e-47b1ac548940",
			"key": "email",
			"value": ""
		},
		{
			"id": "d3334077-ae95-46d9-86bb-894d3bd41f53",
			"key": "firstName",
			"value": ""
		},
		{
			"id": "7a4f545f-78ec-4c7d-b7c2-f7455f213eec",
			"key": "lastName",
			"value": ""
		},
		{
			"id": "337ddf03-f454-41c3-a819-ef1a656b156c",
			"key": "login",
			"value": ""
		},
		{
			"id": "92dcc20f-2a9d-4cc9-81ea-760dbb9fce13",
			"key": "password",
			"value": ""
		},
		{
			"id": "372c4f0d-78f2-4b6a-801a-c3c9439a0f17",
			"key": "userId",
			"value": ""
		},
		{
			"id": "e8d98511-7d3a-45d9-a67f-5629fc480387",
			"key": "version1",
			"value": ""
		}
	],
	"protocolProfileBehavior": {}
}